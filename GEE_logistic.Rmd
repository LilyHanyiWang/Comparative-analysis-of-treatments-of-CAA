---
title: "Logistic Regression Models for the VQI FBVAR Dataset"
author: "Jennifer Ci, Thu Vu, Lily Hanyi Wang"
output: html_document
---

```{r library, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
library(tidyverse)
library(Hmisc)
library(ggplot2)
library(ggpubr)
library(knitr)
library(finalfit)
library(geepack)
library(gtsummary)
```

```{r setup wd}
## ------------- working directories for Lily ----------
wd_lily = '/Users/hanyiwang/Desktop/Comparative-analysis-of-treatments-of-CAA'
path_lily = c("../data/TEVAR_PROC.csv")


## ------------- working directories for Jenn ----------
# wd_jenn = 
# path_jenn = 

## ------------- working directories for Thu ----------
wd_thu = '/Users/thuvu/Desktop/Comparative-analysis-of-treatments-of-CAA'
path_thu = c("FBVAR.csv")

## ------------- read data ----------
setwd(wd_lily)
TEVAR_PROC = read.csv(path_lily)

# setwd(wd_jenn)
# FBVAR = read.csv(path_jenn)

# setwd(wd_thu)
# FBVAR = read.csv(path_thu)

```

Variables to adjust for:

- cluster on `CENTERID` 

- `AGECAT`, `GENDER`, `PREOP_SMOKING`, `PRIOR_AORSURG`, `PRIOR_CHF`, `PREOP_DIALYSIS`

- `PATHOLOGY`, `extent`

In the model, we merge groups for the  `extent`: merge "Juxtarenal AAA" with "Type 4 TAAA"; "Type 1 TAAA", "Type 2 TAAA", "Type 3 TAAA", with "Type 5 TAAA". Now `extent` is a binary variable, Juxtarenal or not.

Outcome variables:

- `POSTOP_CEREBROSX`, `POSTOP_SPINAL_ISCHEMIA`, `POSTOP_DIALYSIS`, `POSTOP_LOS`, `POSTOP_COMPLICATIONS`, `POSTOP_LEGEMBO`, `POSTOP_RESPIRATORY`, `RETX_R_RTOR`, `BRANCH_POST`


# Logistic regression for categorical outcomes


```{r}
## ------------- modify variables ----------

names <- c('PRESENTATION','POSTOP_LOS', 'POSTOP_COMPLICATIONS', 'POSTOP_DIALYSIS', 'POSTOP_LEGEMBO', 'POSTOP_CEREBROSX', 'POSTOP_RESPIRATORY', 'POSTOP_SPINAL_ISCHEMIA', 'RETX_R_RTOR', 'BRANCH_POST','AGECAT', 'GENDER', 'PREOP_SMOKING', 'PRIOR_AORSURG', 'PRIOR_CHF', 'PATHOLOGY', 'extent', 'NUM_TREATED_BRANCHES', 'NUM_TREATED_RENALS','OCCLUDED_RENAL', 'OCCLUDED_SMA', 'OCCLUDED_CELIAC','ARMNECK_ACCESS','CENTERID','PREOP_DIALYSIS')
TEVAR_PROC[,names] <- lapply(TEVAR_PROC[,names] , factor)

TEVAR_PROC = TEVAR_PROC %>%
  mutate(extent = factor(extent,levels = c("Juxtarenal AAA","Type 1 TAAA","Type 2 TAAA","Type 3 TAAA","Type 4 TAAA","Type 5 TAAA"),labels = c('Juxtarenal','No','No','No','Juxtarenal','No')))



# #count unique values for each variable
# sapply(lapply(TEVAR_PROC, unique), length)
# 
# #display unique values for each variable
# lapply(TEVAR_PROC[explanatory], unique)


```


## Stroke: POSTOP_CEREBROSX

Also account for `ARMNECK_ACCESS`

```{r fig.cap='Odds ratio plot for stroke',fig.width=10,fig.height=6}

## ------------- stroke ----------

## ------------- glm ----------

# lr_stroke = glm(POSTOP_CEREBROSX ~ PRESENTATION+ AGECAT + GENDER + PREOP_SMOKING+ PRIOR_AORSURG + PRIOR_CHF + PATHOLOGY + extent+NUM_TREATED_BRANCHES+ NUM_TREATED_RENALS+ OCCLUDED_RENAL+OCCLUDED_SMA+OCCLUDED_CELIAC+ARMNECK_ACCESS,
#     data = FBVAR, family = binomial)
# 
# table2_stroke = lr_stroke %>% tidy(conf.int = TRUE, exp = TRUE)
# knitr::kable(table2_stroke,caption = 'Logistic regression for stroke')
# 
# table2_stroke = lr_stroke %>% summary %>% coef %>% round(3) %>% 
#   as_tibble(rownames="Coefficient") %>% select(1,2,3,5)
# knitr::kable(table2_stroke,caption = 'Logistic regression for stroke')
# 
# test %>% glance() %>% as_tibble() %>% knitr::kable()

## ------------- finalfit with PATHOLOGY and extent ----------
explanatory = c('PRESENTATION','AGECAT', 'GENDER', 'PREOP_SMOKING', 'PREOP_DIALYSIS','PRIOR_AORSURG', 'PRIOR_CHF','PATHOLOGY' ,'extent')

table2_stroke = TEVAR_PROC %>% finalfit(
  dependent = 'POSTOP_CEREBROSX',
  explanatory =  append(explanatory,'ARMNECK_ACCESS') ,
  metrics = TRUE)

knitr::kable(table2_stroke[[1]],caption = 'Logistic regression for stroke')
knitr::kable(table2_stroke[[2]])

## ------------- OR plot ----------
TEVAR_PROC %>% or_plot(
  dependent = 'POSTOP_CEREBROSX',
  explanatory =  append(explanatory,'ARMNECK_ACCESS'),
  breaks = c(0.5, 1, 5, 10, 20))

```


## Spinal cord ischemia model: POSTOP_SPINAL_ISCHEMIA

Also account for `POSTOP_SPINALDRAIN` and `OCCLUDED_CELIAC`

```{r fig.cap='Odds ratio plot for spinal cord ischemia',fig.width=10,fig.height=8}

## ------------- spinal cord ischemia  ----------

## ------------- finalfit ----------
table2_SCI = TEVAR_PROC %>% finalfit(
  dependent = 'POSTOP_SPINAL_ISCHEMIA',
  explanatory =   append(explanatory,c('POSTOP_SPINALDRAIN','OCCLUDED_CELIAC') ) ,
  metrics = TRUE)

knitr::kable(table2_SCI[[1]],caption = 'Logistic regression for spinal cord ischemia')
knitr::kable(table2_SCI[[2]])

## ------------- OR plot ----------

TEVAR_PROC %>% or_plot(
  dependent = 'POSTOP_SPINAL_ISCHEMIA',
  explanatory =  append(explanatory,c('POSTOP_SPINALDRAIN','OCCLUDED_CELIAC') ) ,
  breaks = c(0.5, 1, 5, 10, 20))

```

## Dialysis model: POSTOP_DIALYSIS

Also account for `OCCLUDED_RENAL`


```{r fig.cap='Odds ratio plot for dialysis',fig.width=10,fig.height=8}

## ------------- dialysis  ----------

## ------------- finalfit ----------
table2_DLS = TEVAR_PROC %>% finalfit(
  dependent = 'POSTOP_DIALYSIS',
  explanatory =  append(explanatory,'OCCLUDED_RENAL') ,
  metrics = TRUE)

knitr::kable(table2_DLS[[1]],caption = 'Logistic regression for dialysis')
knitr::kable(table2_DLS[[2]])

## ------------- OR plot ----------

TEVAR_PROC %>% or_plot(
  dependent = 'POSTOP_DIALYSIS',
  explanatory =  append(explanatory,'OCCLUDED_RENAL'),
  breaks = c(0.5, 1, 5, 10, 20))

```

## POSTOP_LOS

- cluster on `CENTERID` 

- `AGECAT`, `GENDER`, `PREOP_SMOKING`, `PRIOR_AORSURG`, `PRIOR_CHF`, `PREOP_DIALYSIS`

- `PATHOLOGY`, `extent`


```{r}
# geeglm(POSTOP_LOS ~ PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PREOP_DIALYSIS+PATHOLOGY+extent,
#        data = na.omit(TEVAR_PROC),
#        id = CENTERID,
#        family = binomial,
#        corstr = "independence")

```


## POSTOP_COMPLICATIONS


## POSTOP_LEGEMBO


## POSTOP_RESPIRATORY


## RETX_R_RTOR

## BRANCH_POST


\newpage

## Code Appendix

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE,include=TRUE}
```
