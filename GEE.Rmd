---
title: "Generalized linear models with the Generalized Estimating Equations for the VQI FBVAR Dataset"
author: "Jennifer Ci, Thu Vu, Lily Hanyi Wang"
output: pdf_document
---


```{r library, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
knitr::opts_chunk$set(fig.width=20, fig.height=20)

library(tidyverse)
library(table1)
library(survival)
library(Hmisc)
library(ggplot2)
library(ggpubr)
library(corrplot)
library(caret)
library(survminer)
library(knitr)
library(kableExtra)
library(dplyr)



```

```{r setup wd}
## ------------- working directories for Lily ----------
#wd_lily = '/Users/hanyiwang/Desktop/Comparative-analysis-of-treatments-of-CAA'
# path_lily = c("../data/FBVAR.csv")

## ------------- working directories for Jenn ----------
wd_jenn = '/Users/jenniferci/Desktop/stlp new laptop/Capstone/Comparative-analysis-of-treatments-of-CAA-main'
path_jenn = c("TEVAR_PROC.csv")

## ------------- working directories for Thu ----------
# wd_thu = '/Users/thuvu/Desktop/Comparative-analysis-of-treatments-of-CAA'
# path_thu = c("FBVAR.csv")

## ------------- read data ----------
#setwd(wd_lily)
#FBVAR = read.csv(path_lily)

#setwd(wd_jenn)
PROC = read.csv(path_jenn)

#find duplicate participants
#n_occur <- data.frame(table(PROC$PATIENTID))
#n_occur[n_occur$Freq > 1,]

#PROC[PROC$PATIENTID %in% n_occur$Var1[n_occur$Freq > 1],]


# setwd(wd_thu)
# FBVAR = read.csv(path_thu)

```

# Generalized linear models with the Generalized Estimating Equations for continuous outcomes 
```{r}
library(geepack)
library(gtsummary)

PROC = PROC %>%
  mutate(extent = factor(extent,levels = c("Juxtarenal AAA","Type 1 TAAA","Type 2 TAAA",
                                           "Type 3 TAAA","Type 4 TAAA","Type 5 TAAA"),
                         labels = c('Juxtarenal','No','No','No','Juxtarenal','No')))
```


```{r}
#change to bianry variables
PROC = PROC %>% mutate(
TOTAL_LOSM = (ifelse(TOTAL_LOS>7, ">7",
                     ifelse( TOTAL_LOS<=7, "<=7",NA))),
ICUSTAYM = (ifelse(ICUSTAY>4, ">4",
                 ifelse(ICUSTAY<=4,"<=4",NA))),
GFRCHANGE=(PROC$PREOP_GFR - PROC$POSTOP_GFR)/PROC$PREOP_GFR,
GFRFIFTY = (ifelse(GFRCHANGE<0.5, "<50%",
                     ifelse(GFRCHANGE>=0.5, ">=50%",NA))),
TREATED_RENALS = (ifelse(NUM_TREATED_RENALS<1, "No",
                     ifelse(NUM_TREATED_RENALS>=1, "Yes",NA))))

PROC$TOTAL_LOSMb <- as.numeric(PROC$TOTAL_LOSM != "<=7") 
PROC$ICUSTAYMb <- as.numeric(PROC$ICUSTAYM != "<=4") 
PROC$POSTOP_INTISCHMb<-as.numeric(PROC$POSTOP_INTISCH != "No") 
PROC$GFRFIFTYMb <- as.numeric(PROC$GFRFIFTY != "<50%") 
#PROC%>% select(GFRFIFTY,GFRFIFTYMb)

#PROC[PROC$PATIENTID %in%c('510979', '558643', '259097', '603199' ,'246350', '598705','554182'),]


#check the variables
#PROC%>% select(TOTAL_LOSM,TOTAL_LOS,TOTAL_LOSMb)
#class(PROC$TOTAL_LOSMb)
#PROC%>% select(ICUSTAYM,ICUSTAY,ICUSTAYMb)
#PROC%>% select(POSTOP_INTISCH,POSTOP_INTISCHMb)
#check the GFR
#a<-PROC%>% filter(is.na(PREOP_GFR_CAT))%>% select(PREOP_CREAT,POSTOP_HIGHCREAT, PREOP_GFR,PREOP_GFR_CAT,POSTOP_GFR,POSTOP_GFR_CAT)
```



## TOTAL_LOS
Length of Stay in days calculated by DISCHARGE_DT - ADMIT_DT
```{r}
#table(PROC$extent)

#remove missing values
PROCNM<-subset(PROC, !is.na(extent))
#PROCNM<-subset(PROCNM, is.na(PREOP_GFR_CAT))

#PROCNM[is.na(PROCNM) | PROCNM=="Inf"] = NA
# repeated patients, need id, geeglm needs complete data, extent is not complete
#unadjusted


LOS1<-geeglm(TOTAL_LOSMb~ PRESENTATION, data=PROCNM, family=binomial(link="logit"), id = CENTERID, corstr = "independence") 

t1<-LOS1 %>%tbl_regression(exponentiate=TRUE,tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t1),tab_spanner ="**TOTAL_LOS Length of Stay in days**")%>%as_flex_table()


#adjusted
LOS2<-geeglm(TOTAL_LOSMb ~ PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PREOP_DIALYSIS+PATHOLOGY+extent
            , data=PROCNM, family=binomial(link="logit"),id = CENTERID, corstr = "independence") 
t2<-LOS2 %>%tbl_regression(exponentiate=TRUE,tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t2),tab_spanner ="**TOTAL_LOS Length of Stay in days**")%>%as_flex_table()


#the difference in mean number of sessions attended comparing treatment to control


#adjust<-c('PRESENTATION','AGECAT', 'GENDER', 'PREOP_SMOKING','PRIOR_AORSURG', 'PRIOR_CHF','PATHOLOGY','NUM_TREATED_BRANCHES')
#PROC %>%
#  tbl_uvregression(
#    y = TOTAL_LOS, 
#    x = PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PATHOLOGY+NUM_TREATED_BRANCHES,
#    method = geepack::geeglm,
#    method.args = list(id = X+CENTERID, corstr = "independence"),
#    include = all_of(adjust)
#  ) %>%
#  as_kable()


```

\newpage



## ICUSTAY
ICU Stay
```{r}
#unadjusted
ICU1<-geeglm(ICUSTAYMb~ PRESENTATION, data=PROCNM, family=binomial(link="logit"), id = CENTERID, corstr = "independence") 

#summary(LOS2)
#summary(ICU1)

#ICU1<-geeglm(ICUSTAY ~ PRESENTATION, data=PROCNM,id = CENTERID, corstr = "independence") 
t1<-ICU1 %>%tbl_regression(exponentiate=TRUE, tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t1),tab_spanner ="**ICU Stay**")%>%as_flex_table()

#adjusted
ICU2<-geeglm(ICUSTAYMb ~ PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PREOP_DIALYSIS+PATHOLOGY+extent
            , family=binomial(link="logit"), data=PROCNM, id = CENTERID, corstr = "independence") 
t2<- ICU2 %>%tbl_regression(exponentiate=TRUE,tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t2),tab_spanner ="**ICU Stay**")%>%as_flex_table()
```

\newpage




```{r eval=FALSE, include=FALSE}
## POSTOP_PRBC
#Transfusion # Units PRBC
#unadjusted
POSTOP_PRBC1<-geeglm(POSTOP_PRBC ~ PRESENTATION, data=PROCNM,id = CENTERID, corstr = "independence") 
t1<-POSTOP_PRBC1 %>%tbl_regression(tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t1),tab_spanner ="**Transfusion # Units PRBC**")%>%as_flex_table()


#adjusted
POSTOP_PRBC2<-geeglm(POSTOP_PRBC ~ PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PREOP_DIALYSIS+PATHOLOGY+extent, data=PROCNM, id = CENTERID+X, corstr = "independence") 
t2<- POSTOP_PRBC2 %>%tbl_regression(tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)
tbl_merge(tbls = list(t2),tab_spanner ="**Transfusion # Units PRBC**")%>%as_flex_table()


```
\newpage


## POSTOP_HIGHCREAT
Highest Creatinine 
1 - GFR reduction is >=50%
0 - GFR reduction is <50%
```{r}
#table(PROC$GFRFIFTY)

#unadjusted
GFR1<-geeglm(GFRFIFTYMb~ PRESENTATION, data=PROCNM, family=binomial(link="logit"), id = CENTERID, corstr = "independence") 

#summary(LOS2)
#summary(ICU1)

#ICU1<-geeglm(ICUSTAY ~ PRESENTATION, data=PROCNM,id = CENTERID, corstr = "independence") 
t1<-GFR1 %>%tbl_regression(exponentiate=TRUE, tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t1),tab_spanner ="**GFR**")%>%as_flex_table()


#table(PROCNM$PREOP_GFR_CAT)


#adjusted
GFR2<-geeglm(GFRFIFTYMb ~ PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PREOP_GFR_CAT+TREATED_RENALS+PATHOLOGY+extent
            , family=binomial(link="logit"), data=PROCNM, id = CENTERID, corstr = "independence") 
t2<- GFR2 %>%tbl_regression(exponentiate=TRUE,tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t2),tab_spanner ="**GFR**")%>%as_flex_table()
```







```{r eval=FALSE, include=FALSE}
#unadjusted
POSTOP_HIGHCREAT1<-geeglm(POSTOP_HIGHCREAT ~ PRESENTATION, data=PROCNM,id = CENTERID, corstr = "independence") 
t1<-POSTOP_HIGHCREAT1 %>%tbl_regression(tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t1),tab_spanner ="**Highest Creatinine**")%>%as_flex_table()

#adjusted
POSTOP_HIGHCREAT2<-geeglm(POSTOP_HIGHCREAT ~ PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PREOP_DIALYSIS+PATHOLOGY+extent
                         , data=PROCNM, id = CENTERID, corstr = "independence") 
t2<- POSTOP_HIGHCREAT2 %>%tbl_regression(tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)
tbl_merge(tbls = list(t2),tab_spanner ="**Highest Creatinine**")%>%as_flex_table()




```
\newpage


## POSTOP_INTISCH
Intestinal Ischemia
```{r}

#unadjusted
POSTOP_INTISCH1<-geeglm(POSTOP_INTISCHMb ~ PRESENTATION, family=binomial(link="logit"), data=PROCNM,id = CENTERID, corstr = "independence") 

t1<-POSTOP_INTISCH1 %>%tbl_regression(exponentiate=TRUE,tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)

tbl_merge(tbls = list(t1),tab_spanner ="**Intestinal Ischemia**")%>%as_flex_table()


#adjusted
POSTOP_INTISCH2<-geeglm(POSTOP_INTISCHMb ~ PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PREOP_DIALYSIS+PATHOLOGY+extent
                       , data=PROCNM,family=binomial(link="logit"), id = CENTERID, corstr = "independence") 
t2<- POSTOP_INTISCH2 %>%tbl_regression(exponentiate=TRUE,tidy_fun = broom.mixed::tidy)%>%
  bold_p(t = 0.05)
tbl_merge(tbls = list(t2),tab_spanner ="**Intestinal Ischemia**")%>%as_flex_table()



#model<-geeglm(as.numeric(POSTOP_DIALYSIS)~PRESENTATION+AGECAT+GENDER+PREOP_SMOKING+PRIOR_AORSURG+PRIOR_CHF+PATHOLOGY+NUM_TREATED_BRANCHES, family=binomial(link = "logit"), data=PROC, id = X, corstr = "independence")


#model<-geeglm(outcome~predictor+confounder, family=binomial(link = "logit"), 
#data=na.omit(data), corstr='ar1', id=id, std.err="san.se")
#TOTAL_LOS

#ICUSTAY
#POSTOP_PRBC
#POSTOP_HIGHCREAT

#POSTOP_INTISCH



```






## Correlation matrix
```{r fig.height=20, fig.width=20}
library(corrplot)
library(tidyverse)
library(caret)
library(ggcorrplot)

matrix <- PROC %>%
    select_if(is.numeric) %>% subset(., select = -1)%>%
    cor(.,use = "complete")

corrplot(matrix, method="number")



#select dataset that column are not numeric
matrix <- PROC %>% select_if(negate(is.numeric))

  
# find out the variables
lapply(matrix[,], unique)
sapply(lapply(matrix, unique), length)

#select if more than one variable
y<-matrix %>%select_if(function(col) length(unique(col))==2)

# Convert all columns to factor
data3 <- as.data.frame(unclass(y),                     
                       stringsAsFactors = TRUE)



 model.matrix(~0 +., data=data3) %>% 
  cor(use="pairwise.complete.obs") %>%
  ggcorrplot(show.diag = F, type="lower", lab=TRUE, lab_size=2)




str(y) 



```


\newpage

## Code Appendix

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE,include=TRUE}
```
