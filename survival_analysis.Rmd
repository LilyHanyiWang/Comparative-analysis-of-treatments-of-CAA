---
title: "Survival Analysis for the VQI FBVAR Dataset"
author: "Jennifer Ci, Thu Vu, Lily Hanyi Wang"
output: pdf_document
---

```{r library, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
knitr::opts_chunk$set(fig.width=20, fig.height=20)

library(tidyverse)
library(table1)
library(survival)
library(Hmisc)
library(ggplot2)
library(ggpubr)
library(corrplot)
library(caret)
library(survminer)
library(knitr)
library(kableExtra)

```

```{r setup wd}
## ------------- working directories for Lily ----------
wd_lily = '/Users/hanyiwang/Desktop/Comparative-analysis-of-treatments-of-CAA'
path_lily = c("../data/FBVAR.csv")


## ------------- working directories for Jenn ----------
# wd_jenn = 
# path_jenn = 

## ------------- working directories for Thu ----------
wd_thu = '/Users/thuvu/Desktop/Comparative-analysis-of-treatments-of-CAA'
path_thu = c("FBVAR.csv")

## ------------- read data ----------
setwd(wd_lily)
FBVAR = read.csv(path_lily)

# setwd(wd_jenn)
# FBVAR = read.csv(path_jenn)

# setwd(wd_thu)
# FBVAR = read.csv(path_thu)

```


# Cox proportional hazards model for survival analysis

Unadjusted survival curves. Time scale changed from calendar days to calendar years. Used log rank test to produce p-value. Median survival never reached. 

Any changes needed? (e.g, time scale, colors, change to at risk table, add number of censored and/or uncensored events, etc.)

```{r, fig.width=8, fig.height=6}
## Survival analysis
# event = 1 for uncensored (Dead), event = 0 for censored (Alive)
FBVAR$event <- ifelse(FBVAR$DEAD=="TRUE", 1, 0)

tte <- FBVAR %>% with(Surv(PROC_SURVIVALDAYS/365, event))

# compute survival curves
fit <- survfit(tte ~ PRESENTATION, data=FBVAR)

# plotting Kaplan-Meier Curves
ggsurvplot(fit,
           pval = TRUE, 
           risk.table = TRUE, 
           linetype = "strata",
           surv.median.line = "hv", 
           ggtheme = theme_bw(), 
           xlab = "Time in years",
           legend.labs = c("Asymptomatic", "Symptomatic"),
           break.time.by=1) 
```

Univariate (unadjusted) and Multivariate (adjusted) Cox Proportional Hazards Models. Reference group is asymptomatic patients. 

Adjusted for the following variables: `AGECAT`, `GENDER`, `PREOP_SMOKING`, `PRIOR_AORSURG`, `PRIOR_CHF`, `PATHOLOGY`, `extent`, `POSTOP_LOS`, `POSTOP_COMPLICATIONS`, `POSTOP_DIALYSIS`, `POSTOP_LEGEMBO`, `POSTOP_CEREBROSX`, `POSTOP_RESPIRATORY`, `POSTOP_SPINAL_ISCHEMIA` , `RETX_R_RTOR` , and `BRANCH_POST`. 

Hazard ratio went from 1.88 to 1.58 after adjustment (0.3 difference). 

```{r, fig.width=8, fig.height=6}
# Unadjusted survival model
mod.cox1 <- coxph(tte ~ PRESENTATION, data=FBVAR)

tab1 <- data.frame(
  Estimate = round(summary(mod.cox1)$conf.int[1],2),
  "Lower 95% CI" = round(summary(mod.cox1)$conf.int[3],2),
  "Upper 95% CI" = round(summary(mod.cox1)$conf.int[4],2),
  "P-value" = "<0.001"
)
rownames(tab1) <- c("Symptomatic (Unadjusted)")

# Adjusted survival model
mod.cox2 <- coxph(tte ~ PRESENTATION + cluster(CENTERID) + AGECAT + GENDER + PREOP_SMOKING 
                 + PRIOR_AORSURG + PRIOR_CHF + PATHOLOGY + extent + POSTOP_LOS
                 + POSTOP_COMPLICATIONS + POSTOP_DIALYSIS + POSTOP_LEGEMBO + POSTOP_CEREBROSX
                 + POSTOP_RESPIRATORY + POSTOP_SPINAL_ISCHEMIA + RETX_R_RTOR + BRANCH_POST, 
                 data=FBVAR)

tab2 <- data.frame(
  Estimate = round(summary(mod.cox2)$conf.int[1],2),
  "Lower 95% CI" = round(summary(mod.cox2)$conf.int[1,3],2),
  "Upper 95% CI" = round(summary(mod.cox2)$conf.int[1,4],2),
  "P-value" = "0.01"
)
rownames(tab2) <- c("Symptomatic (Adjusted)")

t <- rbind(tab1, tab2)
colnames(t) <- c("Hazard Ratio Estimate", "Lower 95% CI", "Upper 95% CI",
                    "P-value")

kable(t)
```

\newpage

## Code Appendix

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE,include=TRUE}
```
