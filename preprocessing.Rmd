---
title: "preprocessing"
author: "Jennifer Ci, Thu Vu, Lily Hanyi Wang"
output: pdf_document
---

```{r library, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,message = FALSE,warning = FALSE)
library(tidyverse)
library(table1)

```


```{r setup wd}
## ------------- working directories for Lily ----------
wd_lily = '/Users/hanyiwang/Desktop/Comparative-analysis-of-treatments-of-CAA'
path_lily = c(
  "../data/TEVAR_International_20210712/TEVAR_International_LTF_r12_2_14_20210701.csv",
  "../data/TEVAR_International_20210712/TEVAR_International_PROC_r12_2_14_20210701.csv",
  "../data/TEVAR_International_20210901/TEVAR_International_LTF_r12_2_14_20210901.csv",
  "../data/TEVAR_International_20210901/TEVAR_International_PROC_r12_2_14_20210901.csv")


## ------------- working directories for Lily ----------
wd_jenn = '/Users/jenniferci/Desktop/Comparative-analysis-of-treatments-of-CAA'
path_jenn = c(
  "/Users/jenniferci/Desktop/Comparative-analysis-of-treatments-of-CAA/TEVAR_International_20210712/TEVAR_International_LTF_r12_2_14_20210701.csv",
  "/Users/jenniferci/Desktop/Comparative-analysis-of-treatments-of-CAA/TEVAR_International_20210712/TEVAR_International_PROC_r12_2_14_20210701.csv",
  "/Users/jenniferci/Desktop/Comparative-analysis-of-treatments-of-CAA/TEVAR_International_20210901/TEVAR_International_LTF_r12_2_14_20210901.csv",
  "/Users/jenniferci/Desktop/Comparative-analysis-of-treatments-of-CAA/TEVAR_International_20210901/TEVAR_International_PROC_r12_2_14_20210901.csv")

## ------------- read data ----------
setwd(wd_lily)
TEVAR_LTF_07 = read.csv(path_lily[1])
TEVAR_PROC_07 = read.csv(path_lily[2])
#TEVAR_LTF_09 = read.csv(path_lily[3])
#TEVAR_PROC_09 = read.csv(path_lily[4])

setwd(wd_jenn)
TEVAR_LTF_07 = read.csv(path_jenn[1])
TEVAR_PROC_07 = read.csv(path_jenn[2])
#TEVAR_LTF_09 = read.csv(path_lily[3])
#TEVAR_PROC_09 = read.csv(path_lily[4])
```

## merge the datasets

Compare the data from July 2021 and September 2021. Keep the most updated ones.

Merge the long term follow-up dataset and the pre-procedure dataset by `PATIENTID`.

```{r}
## ------------- merge the data----------
total <- merge(TEVAR_LTF_07,TEVAR_PROC_07,by="PATIENTID")
colnames(total)[grepl(".y",colnames(total))]

total
combined <- total %>% 
  rename_at(
    vars(ends_with(".x")),
    ~str_replace(., "\\..$","")
  ) %>% 
  select_at(
    vars(-ends_with(".y"))
  )


```

## data cleaning based on inclusion, exclusion criteria

Exclusion criteria:

- `PRESENTATION` exclude rupture patients

- `PATHOLOGY` exclude groups with pathology: 4=trauma, 8 = Aortic Thrombus,9 = Other (Retired) (retired since 09/30/2014),10 = Aorto-esophageal Fistula (Retired) (retired since 09/30/2014),11 = Aorto-bronchial Fistula (Retired) (retired since 09/30/2014)

*include the indication, merge the two columns*

- `URGENCY`: exclude rupture. (elective is same to asymptomatic)

- `PROXZONE_DISEASE`: exclude 0 and 1 

```{r}
## ------------- inclusion and exclusion----------
TEVAR_PROC_07 = TEVAR_PROC_07 %>% 
  filter(PRESENTATION !=2) %>%
  filter(PATHOLOGY %in% c(1,2,3,5,6,7)) %>%
  filter(URGENCY %in% c(1,2,3)) %>%
  filter(PROXZONE_DISEASE %in% c(2,3,4,5,6,7,8,9))

## ------------- data cleaning----------
TEVAR_PROC_07 = TEVAR_PROC_07 %>% 
  mutate(DEAD=factor(DEAD)) %>%
  mutate(PRESENTATION = factor(PRESENTATION,levels = c(0,1),
                               labels = c('Asymptomatic','Symptomatic'))) %>%
  mutate(AGECAT = factor(AGECAT,levels = c(1,2,3,4,5,6,7),
                         labels = c('<40','40-49','50-59','60-69','70-79','80-89','>89'))) %>%
  mutate(GENDER=factor(GENDER,levels=c(1,2),
                       labels=c('male','female'))) %>%
  mutate(SURGYEAR=factor(SURGYEAR)) %>%
  mutate(PROXZONE_DISEASE=factor(PROXZONE_DISEASE)) %>%
  mutate(URGENCY=factor(URGENCY,levels = c(1,2,3),labels = c('Elective','Urgent','Emergent'))) %>%
  mutate(PATHOLOGY=factor(PATHOLOGY,levels=c(1,2,3,5,6,7),
                          labels = c('Aneurysm','Dissection','Aneurysm from dissection','PAU',
                                     'IMH','PAU with IMH')))

```


## population of interest: the asymptomatic and symptomatics groups. 

```{r}
## ------------- population of interest ----------
table1(~  PRESENTATION, data = TEVAR_PROC_07)
```



## Demographic history

```{r}
## ------------- table1: demographic----------
table1(~ GENDER+AGE+AGECAT
         | PRESENTATION, data = TEVAR_PROC_07)
```

## anatomy

```{r}
## ------------- table: anatomy ----------
table1(~ PATHOLOGY+PROXZONE_DISEASE | PRESENTATION, data = TEVAR_PROC_07)
```


## patient condition variables:

`PRIOR_CVD`: 0 = None,1 = hx stroke, asymptomatic,2 = hx stroke, minor deficit,3 = hx stroke, major deficit

`PRIOR_CAD`: 0 = None,1 = hx MI but no sx,2 = Stable angina,3 = Unstable angina or MI < 6 mos (retired since 09/12/2012),4 = MI < 6 mos,5 = Unstable angina

`PRIOR_CHF`: 0 = None,1 = Asymp, hx CHF,2 = Mild,3 = Moderate,4 = Severe

`COPD`: 0 = No,1 = Not Treated,2 = On Meds,3 = On Home Oxygen

`DIABETES`: 0 = None,1 = Diet,2 = Non-insulin Meds,3 = Insulin

`HTN`: History of hypertension; 0 = No, 1 = Yes (>=140/90 or history) (retired since 11/15/2016), 2 = Yes, controlled  [added on 04/13/2020] , 3 = Yes, uncontrolled  [added on 04/13/2020]

`PREOP_SMOKING`: 0 = Never,1 = Prior,2 = Current

`PRIOR_AORSURG`: Any aortic procedures performed on a separate date prior to the index procedure; 0 = None,1 = Open,2 = Endo,3 = Both,4 = Other (retired since 09/30/2014)

```{r}
## ------------- table: patients conditions ----------
table1(~ factor(R_PREOP_AMBUL)+factor(PREOP_SMOKING)+factor(PRIOR_CVD)+
         factor(PRIOR_CAD)+factor(PRIOR_CHF)+factor(COPD)+factor(DIABETES)+factor(HTN)+
         factor(PRIOR_AORSURG)
       | PRESENTATION, data = TEVAR_PROC_07)

```

## other variables

Surgery year would affect outcome, since surgeons got more familiar with the surgery.

```{r}
plot(DEAD~SURGYEAR,data=TEVAR_PROC_07)
```


## Outcome variables

`PROC_SURVIVALDAYS`: This should be the longest known time of survival data available for the patient. 
Survival days are calculated as the Last Date of Contact (or Date of Death) for the patient - Procedure date for a procedure. Please refer to included Death and Survival Days Logic.pdf for additional details."

`POSTOP_LOS`: Length of Stay in days calculated by DISCHARGE_DT - SURGERY_DT


```{r}
## ------------- table3: outcomes----------
table1(~ factor(DEAD) + PROC_SURVIVALDAYS+POSTOP_LOS | PRESENTATION, data = TEVAR_PROC_07)

## ------------- Survival curves----------

```

## Clustering variables:

```{r}
## ------------- clustering variables----------

#TEVAR_PROC_07 %>% select(REGIONID) %>% table() 
#TEVAR_PROC_07 %>% select(CENTERID) %>% table() 
#TEVAR_PROC_07 %>% select(PHYSICIANID) %>% table() 
```

`r nlevels(factor(TEVAR_PROC_07$REGIONID))` regions, `r nlevels(factor(TEVAR_PROC_07$CENTERID))` centers, `r nlevels(factor(TEVAR_PROC_07$PHYSICIANID))` physicians. 

Most physicians only performed 1 or 2 procedures. Several performed over 100 procedures. Since the more surgeries a surgeon did, the more familiar he or she is. So we need to cluster on this.

*Cluster on centers and physicians*

\newpage
### Code Appendix

```{r, ref.label=knitr::all_labels(),echo=TRUE,eval=FALSE,include=TRUE}
```


